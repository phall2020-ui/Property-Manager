// Prisma schema for Property Management MVP
// Database: SQLite (dev) / PostgreSQL (prod)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS (SQLite uses String instead of enum)
// ============================================================================

// Role values: LANDLORD, TENANT, OPS

// ============================================================================
// CORE MODELS
// ============================================================================

// Organisation (multi-tenant isolation)
model Org {
  id        String   @id @default(uuid())
  name      String
  type      String // LANDLORD, TENANT
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members           OrgMember[]
  propertiesOwned   Property[]  @relation("OwnedProperties")
  tenanciesAsTenant Tenancy[]   @relation("TenantOrg")
  invitesSent       Invite[]
}

// User accounts
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  passwordHash String
  role         String?  // LANDLORD, TENANT, OPS (optional for backward compatibility)
  landlordId   String?  // New: For linking to landlord org
  phone        String?
  notifyEmail  Boolean  @default(true)
  notifySms    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orgMemberships          OrgMember[]
  refreshTokens           RefreshToken[]
  ticketsCreated          Ticket[]       @relation("TicketCreator")
  ticketsAssigned         Ticket[]       @relation("TicketAssignee")
  quotesCreated           Quote[]
  notesCreated            PropertyNote[]
  mandates                Mandate[]
  contractorAppointments  Appointment[]  @relation("ContractorAppointments")

  @@index([email])
  @@index([landlordId])
}

// Organisation membership with roles
model OrgMember {
  id        String   @id @default(uuid())
  orgId     String
  userId    String
  role      String // LANDLORD, TENANT, CONTRACTOR, ADMIN
  createdAt DateTime @default(now())

  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([userId])
  @@index([orgId])
}

// Refresh token storage for rotation
model RefreshToken {
  id         String    @id @default(uuid())
  userId     String
  jti        String    @unique
  expiresAt  DateTime
  revokedAt  DateTime?
  replacedBy String?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([jti])
}

// Session storage for refresh tokens (alternative model for new auth flow)
model Session {
  id          String   @id @default(uuid())
  userId      String
  refreshHash String
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([userId])
}

// Landlord entity (as per Step 2 requirements)
model Landlord {
  id           String     @id @default(uuid())
  name         String
  billingEmail String
  createdAt    DateTime   @default(now())
  properties   Property[] @relation("LandlordProperties")

  @@index([id])
}

// ============================================================================
// PROPERTY & TENANCY MODELS
// ============================================================================

// Properties owned by landlord organisations
model Property {
  id             String   @id @default(uuid())
  landlordId     String?  // New: Direct landlord reference as per Step 2 requirements
  addressLine1   String   // Renamed from address1 to match Step 2 spec
  address2       String?
  city           String
  postcode       String
  councilTaxBand String?  // New: as per Step 2 spec
  bedrooms       Int?
  propertyType   String?  // House, Flat, HMO, Maisonette, Bungalow, Other
  furnished      String?  // Unfurnished, Part, Full
  epcRating      String?  // A-G or Unknown
  propertyValue  Float?   // For yield calculations
  ownerOrgId     String   // Keep for backward compatibility
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  landlord  Landlord?        @relation("LandlordProperties", fields: [landlordId], references: [id], onDelete: SetNull)
  owner     Org              @relation("OwnedProperties", fields: [ownerOrgId], references: [id], onDelete: Cascade)
  tenancies Tenancy[]
  tickets   Ticket[]
  documents PropertyDocument[]
  notes     PropertyNote[]
  auditLogs AuditLog[]

  @@index([ownerOrgId])
  @@index([landlordId])
}

// Tenancies linking properties to tenant organisations
model Tenancy {
  id           String    @id @default(uuid())
  propertyId   String
  landlordId   String?   // New: Direct landlord reference (Step 2)
  tenantOrgId  String    // Keep for backward compatibility
  primaryTenant String?  // userId of the main tenant
  start        DateTime  // Renamed from startDate (Step 2 spec)
  startDate    DateTime? // Keep for backward compatibility  
  end          DateTime? // Renamed from endDate (Step 2 spec)
  endDate      DateTime? // Keep for backward compatibility
  rent         Float     // New: rent amount as Decimal equivalent (Step 2)
  rentPcm      Float?    // Keep for backward compatibility
  rentAmount   Float?    // Keep for backward compatibility
  frequency    String    @default("MONTHLY") // MONTHLY, WEEKLY (Step 2 spec)
  rentFrequency String?  // Keep for backward compatibility
  rentDueDay   Int?      // 1-28
  deposit      Float     // Decimal(14,2) equivalent
  externalRef  String?   @unique // New: for idempotency (Step 2)
  status       String    @default("PENDING") // PENDING, ACTIVE, ENDED, SCHEDULED, EXPIRING, TERMINATED
  
  // Lifecycle fields
  terminatedAt      DateTime?
  terminationReason String?
  renewalOfId       String?  // reference to prior tenancy when renewed
  
  // Legal & Deposit
  depositScheme          String? // DPS, TDS, MyDeposits, None
  depositProtectedAt     DateTime?
  prescribedInfoServedAt DateTime?
  howToRentServedAt      DateTime?
  rightToRentCheckedAt   DateTime?

  // Compliance dates
  gasSafetyDueAt         DateTime?
  eicrDueAt              DateTime?
  epcExpiresAt           DateTime?
  boilerServiceDueAt     DateTime?
  smokeAlarmsCheckedAt   DateTime?
  coAlarmsCheckedAt      DateTime?
  legionellaAssessmentAt DateTime?

  // HMO & Licensing
  hmo                       Boolean   @default(false)
  hmoLicenceNumber          String?
  hmoLicenceExpiresAt       DateTime?
  selectiveLicence          Boolean   @default(false)
  selectiveLicenceExpiresAt DateTime?

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  property      Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenantOrg     Org               @relation("TenantOrg", fields: [tenantOrgId], references: [id], onDelete: Cascade)
  renewalOf     Tenancy?          @relation("TenancyRenewal", fields: [renewalOfId], references: [id], onDelete: SetNull)
  renewedBy     Tenancy[]         @relation("TenancyRenewal")
  tickets       Ticket[]
  documents     TenancyDocument[]
  tenants       TenancyTenant[]
  auditLogs     AuditLog[]
  rentSchedules RentSchedule[]
  invoices      Invoice[]
  breakClause   BreakClause?
  guarantors    Guarantor[]
  rentRevisions RentRevision[]

  @@index([propertyId])
  @@index([tenantOrgId])
  @@index([landlordId])
  @@index([externalRef])
  @@index([status])
  @@index([status, end])
}

// Documents attached to tenancies (stored on disk)
model TenancyDocument {
  id        String   @id @default(uuid())
  tenancyId String
  filename  String
  filepath  String
  mimetype  String?
  size      Int?
  createdAt DateTime @default(now())

  tenancy Tenancy @relation(fields: [tenancyId], references: [id], onDelete: Cascade)

  @@index([tenancyId])
}

// Break clause for early termination
model BreakClause {
  id                String   @id @default(uuid())
  tenancyId         String   @unique
  earliestBreakDate DateTime
  noticeMonths      Int      // required notice period
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenancy Tenancy @relation(fields: [tenancyId], references: [id], onDelete: Cascade)
}

// Guarantor support
model Guarantor {
  id        String   @id @default(uuid())
  tenancyId String
  name      String
  email     String
  phone     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenancy Tenancy @relation(fields: [tenancyId], references: [id], onDelete: Cascade)

  @@index([tenancyId])
}

// Rent revision history
model RentRevision {
  id            String   @id @default(uuid())
  tenancyId     String
  effectiveFrom DateTime
  rentPcm       Float    // Using Float for SQLite compatibility
  reason        String?
  createdAt     DateTime @default(now())

  tenancy Tenancy @relation(fields: [tenancyId], references: [id], onDelete: Cascade)

  @@index([tenancyId])
  @@index([effectiveFrom])
}

// ============================================================================
// INVITE SYSTEM
// ============================================================================

// Tenant invitations
model Invite {
  id           String    @id @default(uuid())
  landlordId   String // Maps to Org.id where type='LANDLORD'
  tenancyId    String
  email        String
  token        String    @unique
  status       String    @default("SENT") // SENT, ACCEPTED, EXPIRED
  expiresAt    DateTime
  inviterOrgId String // Keep for backward compatibility
  acceptedAt   DateTime?
  createdAt    DateTime  @default(now())

  inviterOrg Org @relation(fields: [inviterOrgId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([token])
  @@index([email])
  @@index([tenancyId])
  @@index([status])
}

// ============================================================================
// IMPORT JOBS (Step 3)
// ============================================================================

// CSV import jobs with background processing
model ImportJob {
  id         String   @id @default(uuid())
  landlordId String
  type       String   // PROPERTIES, TENANCIES
  status     String   // PENDING, RUNNING, DONE, FAILED
  totals     String?
  errorsUrl  String?
  createdAt  DateTime @default(now())

  @@index([landlordId])
  @@index([status])
}

// Request logs for idempotency (Step 2)
model RequestLog {
  id              String   @id @default(uuid())
  idempotencyKey  String   @unique
  landlordId      String
  method          String
  path            String
  requestBody     String?
  responseStatus  Int?
  responseBody    String?
  createdAt       DateTime @default(now())

  @@index([idempotencyKey])
  @@index([landlordId])
}

// ============================================================================
// MAINTENANCE TICKETS
// ============================================================================

// Vendors (contractors) for maintenance work
model Vendor {
  id         String   @id @default(uuid())
  landlordId String
  name       String
  categories String // JSON array as string: ["plumbing", "electrical"]
  email      String?
  phone      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  quotes Quote[] @relation("VendorQuotes")

  @@index([landlordId])
}

// Maintenance tickets
model Ticket {
  id                    String    @id @default(uuid())
  landlordId            String // For tenant isolation
  propertyId            String?
  tenancyId             String?
  title                 String
  category              String? // plumbing, electrical, heating, etc.
  description           String
  createdById           String
  createdByRole         String    @default("TENANT") // LANDLORD, TENANT, OPS, CONTRACTOR
  assignedToId          String?
  priority              String // LOW, STANDARD, HIGH, URGENT
  status                String    @default("OPEN") // OPEN, TRIAGED, QUOTED, APPROVED, SCHEDULED, IN_PROGRESS, COMPLETED, AUDITED, CANCELLED
  attachments           String? // JSON array as string
  inProgressAt          DateTime? // When status flipped to IN_PROGRESS
  noShowAt              DateTime? // If the job didn't start within grace period
  scheduledWindowStart  DateTime? // Denormalized from Appointment for faster queries
  scheduledWindowEnd    DateTime? // Denormalized from Appointment for faster queries
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  property        Property?          @relation(fields: [propertyId], references: [id])
  tenancy         Tenancy?           @relation(fields: [tenancyId], references: [id])
  createdBy       User               @relation("TicketCreator", fields: [createdById], references: [id])
  assignedTo      User?              @relation("TicketAssignee", fields: [assignedToId], references: [id])
  quotes          Quote[]
  attachmentFiles TicketAttachment[] @relation("TicketAttachments")
  timeline        TicketTimeline[]
  appointments    Appointment[]

  @@index([landlordId])
  @@index([propertyId])
  @@index([tenancyId])
  @@index([createdById])
  @@index([status])
  @@index([status, propertyId])
  @@index([scheduledWindowStart])
}

// Appointments for scheduling maintenance visits
model Appointment {
  id               String    @id @default(uuid())
  ticketId         String
  contractorId     String
  startAt          DateTime // Proposed or confirmed start time
  endAt            DateTime? // Proposed or confirmed end time
  status           String    @default("PROPOSED") // PROPOSED, CONFIRMED, CANCELLED, COMPLETED
  proposedBy       String // User ID who proposed the appointment
  confirmedBy      String? // User ID who confirmed (TENANT or OPS/LANDLORD)
  confirmedAt      DateTime? // When appointment was confirmed
  cancelledBy      String? // User ID who cancelled
  cancelledAt      DateTime?
  cancellationNote String?
  notes            String? // Additional notes
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  ticket     Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  contractor User   @relation("ContractorAppointments", fields: [contractorId], references: [id])

  @@index([ticketId])
  @@index([contractorId])
  @@index([startAt])
  @@index([status, startAt])
}

// Quotes for tickets
model Quote {
  id              String    @id @default(uuid())
  ticketId        String
  vendorId        String? // References Vendor.id
  contractorId    String // Keep for backward compatibility (User contractor)
  amount          Float
  notes           String?
  status          String // PROPOSED, APPROVED, REJECTED
  approvedAt      DateTime?
  completedAt     DateTime?
  completionNotes String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  ticket     Ticket  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  contractor User    @relation(fields: [contractorId], references: [id])
  vendor     Vendor? @relation("VendorQuotes", fields: [vendorId], references: [id])

  @@index([ticketId])
  @@index([contractorId])
  @@index([vendorId])
}

// Attachments for tickets (stored on disk)
model TicketAttachment {
  id        String   @id @default(uuid())
  ticketId  String
  filename  String
  filepath  String
  mimetype  String?
  size      Int?
  createdAt DateTime @default(now())

  ticket Ticket @relation("TicketAttachments", fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

// Approval rules for ticket quotes
model ApprovalRule {
  id                   String   @id @default(uuid())
  landlordId           String
  autoApproveThreshold Float // Amount in currency
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([landlordId])
  @@index([landlordId])
}

// ============================================================================
// DOCUMENTS & TENANTS
// ============================================================================

// Documents attached to properties
model PropertyDocument {
  id         String    @id @default(uuid())
  propertyId String
  docType    String // EPC, Insurance, Title, etc.
  filename   String
  filepath   String
  url        String?
  mimetype   String?
  size       Int?
  expiryDate DateTime?
  createdAt  DateTime  @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
}

// Tenants linked to tenancies
model TenancyTenant {
  id        String   @id @default(uuid())
  tenancyId String
  fullName  String
  email     String
  phone     String?
  status    String   @default("INVITED") // INVITED, PENDING, ACTIVE
  createdAt DateTime @default(now())

  tenancy Tenancy @relation(fields: [tenancyId], references: [id], onDelete: Cascade)

  @@index([tenancyId])
  @@index([email])
}

// Property notes
model PropertyNote {
  id         String   @id @default(uuid())
  propertyId String
  authorId   String
  content    String
  createdAt  DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  author   User     @relation(fields: [authorId], references: [id])

  @@index([propertyId])
}

// Audit log for property & tenancy changes
model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String?  // landlordId for multi-tenant scoping
  actorId    String?  // userId who performed the action
  action     String   // CREATE, UPDATE, DELETE, etc.
  entity     String   // property, tenancy, ticket, document, etc.
  entityId   String   // ID of the entity affected
  propertyId String?  // Keep for backward compatibility
  tenancyId  String?  // Keep for backward compatibility
  eventType  String?  // Keep for backward compatibility
  meta       String?  // JSON metadata with details
  details    String?  // Keep for backward compatibility
  ts         DateTime @default(now()) // Timestamp
  createdAt  DateTime @default(now())

  property Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenancy  Tenancy?  @relation(fields: [tenancyId], references: [id], onDelete: Cascade)

  @@index([tenantId, ts])
  @@index([propertyId])
  @@index([tenancyId])
  @@index([actorId])
  @@index([entity, entityId])
}

// ============================================================================
// FINANCE MODELS
// ============================================================================

// Chart of accounts for double-entry bookkeeping (Step 4)
model LedgerAccount {
  id         String   @id @default(uuid())
  landlordId String
  code       String   // Account code
  name       String
  type       String   // ASSET, LIAB, INCOME, EXPENSE (Step 4 spec)
  currency   String   @default("GBP")
  createdAt  DateTime @default(now())

  entries LedgerEntry[]

  @@index([landlordId])
  @@index([landlordId, type])
  @@index([landlordId, code])
}

// Double-entry ledger for all financial transactions (Step 4)
model LedgerEntry {
  id            String    @id @default(uuid())
  landlordId    String
  propertyId    String?
  tenancyId     String?
  tenantUserId  String?   // References User.id where role=TENANT
  accountId     String
  amount        Float     // Decimal(14,2) equivalent - store in smallest units
  drCr          String    // DR or CR (Step 4 spec)
  direction     String?   // DEBIT, CREDIT (keep for backward compatibility)
  memo          String?   // Description (Step 4 spec)
  description   String?   // Keep for backward compatibility
  refType       String?   // invoice, payment, payout, etc.
  refId         String?   // Reference to related entity
  bookedAt      DateTime  @default(now()) // When transaction was booked (Step 4)
  eventAt       DateTime? // Keep for backward compatibility
  createdAt     DateTime  @default(now())

  account LedgerAccount @relation(fields: [accountId], references: [id], onDelete: Restrict)

  @@index([landlordId, accountId, bookedAt])
  @@index([propertyId, bookedAt])
  @@index([tenancyId])
}

// Settings for landlord configuration (Step 4)
model Setting {
  id         String   @id @default(uuid())
  landlordId String
  key        String
  value      String
  createdAt  DateTime @default(now())

  @@unique([landlordId, key])
  @@index([landlordId])
}

// Rent schedules for forward billing (Step 5)
model RentSchedule {
  id          String   @id @default(uuid())
  landlordId  String
  tenancyId   String
  invoiceDate DateTime
  amount      Float    // Decimal(14,2) equivalent
  status      String   // PENDING, INVOICED, PAID
  createdAt   DateTime @default(now())

  tenancy Tenancy @relation(fields: [tenancyId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([tenancyId])
  @@index([status])
  @@index([invoiceDate])
}

// Invoices for rent and other charges (Step 5)
model Invoice {
  id            String   @id @default(uuid())
  landlordId    String
  propertyId    String
  tenancyId     String
  tenantUserId  String?  // Primary tenant for this invoice
  number        String   @unique // Invoice number (backward compat)
  reference     String   // Human-readable reference e.g. "2025-03 Rent"
  periodStart   DateTime // Billing period start
  periodEnd     DateTime // Billing period end
  issueDate     DateTime? // Keep for backward compatibility
  dueAt         DateTime // When payment is due
  dueDate       DateTime? // Keep for backward compatibility
  amountGBP     Float    // Total amount in GBP (Float for SQLite, Decimal for Postgres)
  amount        Float?   // Keep for backward compatibility
  lineTotal     Float?   // Keep for backward compatibility
  taxTotal      Float?   // Keep for backward compatibility  
  grandTotal    Float?   // Keep for backward compatibility
  status        String   // DRAFT, DUE, PART_PAID, PAID, LATE, VOID
  notes         String?  // Optional notes
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenancy     Tenancy             @relation(fields: [tenancyId], references: [id], onDelete: Cascade)
  lines       InvoiceLine[]
  creditNotes CreditNote[]
  allocations PaymentAllocation[]
  payments    Payment[]

  @@unique([landlordId, number])
  @@unique([tenancyId, periodStart, periodEnd])
  @@index([landlordId, propertyId, tenancyId, dueAt])
  @@index([landlordId, status])
  @@index([propertyId])
  @@index([tenancyId])
  @@index([tenantUserId])
}

// Line items on invoices
model InvoiceLine {
  id          String @id @default(uuid())
  invoiceId   String
  description String
  qty         Float  @default(1.0)
  unitPrice   Float
  taxRate     Float  @default(0.0)
  lineTotal   Float
  taxTotal    Float

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// Credit notes for invoice adjustments
model CreditNote {
  id         String   @id @default(uuid())
  invoiceId  String? // Optional - can be general credit
  landlordId String
  amount     Float
  reason     String
  createdAt  DateTime @default(now())

  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([landlordId])
  @@index([invoiceId])
}

// Payments received from tenants (Step 6)
model Payment {
  id           String    @id @default(uuid())
  landlordId   String
  propertyId   String
  tenancyId    String
  invoiceId    String
  tenantUserId String?   // Keep for backward compatibility
  amountGBP    Float     // Amount in GBP (Float for SQLite, Decimal for Postgres)
  method       String    // BANK_TRANSFER, DD, CARD, CASH, OTHER
  provider     String    // TEST, GOCARDLESS, STRIPE, OPEN_BANKING
  providerRef  String    @unique // Provider reference (unique for idempotency)
  status       String    // PENDING, SETTLED, FAILED
  feeGBP       Float?    // Optional payment processing fee
  vatGBP       Float?    // Optional VAT on fee
  paidAt       DateTime  // When payment was made
  amount       Float?    // Keep for backward compatibility
  receivedAt   DateTime? // Keep for backward compatibility
  externalId   String?   // Keep for backward compatibility
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  invoice     Invoice             @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  allocations PaymentAllocation[]

  @@index([landlordId, tenancyId, paidAt])
  @@index([landlordId, status])
  @@index([invoiceId])
  @@index([propertyId])
  @@index([tenancyId])
  @@index([tenantUserId])
  @@index([externalId])
}

// Allocations of payments to invoices (partial payments supported)
model PaymentAllocation {
  id        String   @id @default(uuid())
  paymentId String
  invoiceId String
  amount    Float
  createdAt DateTime @default(now())

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([invoiceId])
}

// Direct Debit mandates and recurring payment methods (Step 6)
model Mandate {
  id           String    @id @default(uuid())
  landlordId   String
  tenancyId    String    // Step 6 spec links to tenancy
  tenantUserId String?   // Keep for backward compatibility
  provider     String    // gocardless|stripe (Step 6 spec)
  providerRef  String    // Provider mandate ID (Step 6: providerRef)
  reference    String?   // Keep for backward compatibility
  status       String    // PENDING, ACTIVE, FAILED (Step 6 spec)
  createdAt    DateTime  @default(now())
  activatedAt  DateTime?
  updatedAt    DateTime  @updatedAt

  tenantUser User? @relation(fields: [tenantUserId], references: [id], onDelete: Restrict)

  @@index([landlordId])
  @@index([tenancyId])
  @@index([tenantUserId])
  @@index([status])
}

// Payouts to landlord bank accounts
model Payout {
  id               String   @id @default(uuid())
  landlordId       String
  amount           Float
  bankAccountLast4 String?
  paidAt           DateTime
  provider         String? // STRIPE, GOCARDLESS, MANUAL
  reference        String?
  createdAt        DateTime @default(now())

  @@index([landlordId])
  @@index([paidAt])
}

// Bank connection to external provider
model BankConnection {
  id         String   @id @default(uuid())
  landlordId String
  provider   String // MOCK, PLAID, TRUELAYER, etc.
  status     String // PENDING, ACTIVE, ERROR, DISCONNECTED
  meta       String? // JSON metadata
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  accounts BankAccount[]

  @@index([landlordId])
  @@index([status])
}

// Bank account from provider
model BankAccount {
  id            String    @id @default(uuid())
  landlordId    String
  connectionId  String
  name          String
  iban          String?
  accountNumber String?
  sortCode      String?
  lastSyncedAt  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  connection   BankConnection    @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  transactions BankTransaction[]

  @@unique([landlordId, connectionId, name])
  @@index([landlordId])
  @@index([connectionId])
}

// Bank transactions from Open Banking feeds
model BankTransaction {
  id               String   @id @default(uuid())
  landlordId       String
  bankAccountId    String // Internal reference to connected account
  postedAt         DateTime
  description      String
  reference        String? // Payment reference from transaction
  amount           Float
  currency         String   @default("GBP")
  hash             String   @unique // For deduplication
  matchedInvoiceId String? // Direct reference to matched invoice
  confidence       Int? // 0-100 confidence score for auto-match
  rawString          String? // Store original transaction data
  createdAt        DateTime @default(now())

  bankAccount     BankAccount      @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  reconciliations Reconciliation[]

  @@index([landlordId, bankAccountId])
  @@index([postedAt])
  @@index([hash])
  @@index([matchedInvoiceId])
}

// Reconciliation matches between bank transactions and payments/invoices
model Reconciliation {
  id                String   @id @default(uuid())
  landlordId        String
  bankTransactionId String
  matchType         String // AUTO, MANUAL
  confidence        Float // 0.00 to 100.00
  matchedEntityType String? // payment, invoice
  matchedEntityId   String? // ID of payment or invoice
  createdAt         DateTime @default(now())

  bankTransaction BankTransaction @relation(fields: [bankTransactionId], references: [id], onDelete: Cascade)

  @@index([landlordId])
  @@index([bankTransactionId])
}

// Charge rules for rent schedules and late fees
model ChargeRule {
  id         String   @id @default(uuid())
  landlordId String
  type       String // RENT, LATE_FEE, SERVICE_CHARGE, OTHER
  calc       String // JSON config: { frequency, amount, dayOfMonth, lateFeePercent, etc }
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([landlordId, type])
  @@index([isActive])
}

// Periodic snapshots of account balances for performance
model BalanceSnapshot {
  id         String   @id @default(uuid())
  landlordId String
  propertyId String?
  tenancyId  String?
  asOf       DateTime
  rentAR     Float    @default(0.0) // Accounts receivable for rent
  feesAR     Float    @default(0.0) // Accounts receivable for fees
  deposits   Float    @default(0.0) // Deposit liability
  credits    Float    @default(0.0) // Credit balance
  createdAt  DateTime @default(now())

  @@index([landlordId, asOf])
  @@index([propertyId, asOf])
  @@index([tenancyId, asOf])
}

// Finance settings per landlord
model FinanceSettings {
  id               String   @id @default(uuid())
  landlordId       String   @unique
  invoicePrefix    String   @default("INV")
  defaultDueDays   Int      @default(7)
  lateFeeEnabled   Boolean  @default(false)
  lateFeePercent   Float? // Daily percentage
  lateFeeFixed     Float? // Or fixed amount per day
  lateFeeGraceDays Int      @default(0)
  lateFeeCap       Float? // Max late fee per invoice
  vatOnFeesEnabled Boolean  @default(false)
  vatRate          Float    @default(20.0)
  currency         String   @default("GBP")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([landlordId])
}

// Idempotency keys for financial operations
model IdempotencyKey {
  id        String   @id @default(uuid())
  key       String   @unique
  hash      String // Hash of request body
  response  String? // Cached response
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([key])
  @@index([expiresAt])
}

// ============================================================================
// FEATURE FLAGS & EXPERIMENTS (Step 13)
// ============================================================================

// Feature flags per landlord
model FeatureFlag {
  id         String   @id @default(uuid())
  landlordId String
  key        String // enable_bank_feeds, enable_ticketing, auto_invoicing, etc.
  enabled    Boolean  @default(false)
  variant    String? // Optional variant for A/B testing
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([landlordId, key])
  @@index([landlordId])
  @@index([key])
}

// Experiment assignments for A/B testing
model ExperimentAssignment {
  id            String   @id @default(uuid())
  landlordId    String
  experimentKey String // dunning_timing, invoice_reminder, etc.
  variant       String // control, variant_a, variant_b, etc.
  assignedAt    DateTime @default(now())

  @@unique([landlordId, experimentKey])
  @@index([landlordId])
  @@index([experimentKey])
}

// Upsell opportunities for business development
model UpsellOpportunity {
  id         String   @id @default(uuid())
  landlordId String
  type       String // PREMIUM_FEATURES, ADDITIONAL_UNITS, MANAGED_SERVICE, etc.
  status     String // IDENTIFIED, CONTACTED, QUALIFIED, WON, LOST
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([landlordId])
  @@index([status])
  @@index([type])
}

// ============================================================================
// NOTIFICATIONS & EVENTS
// ============================================================================

// Notifications for in-app inbox
model Notification {
  id           String    @id @default(uuid())
  userId       String
  type         String    // ticket.created, invoice.created, etc.
  title        String
  message      String
  resourceType String?   // ticket, invoice, payment, document
  resourceId   String?
  isRead       Boolean   @default(false)
  readAt       DateTime?
  createdAt    DateTime  @default(now())

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([resourceType, resourceId])
}

// Timeline events for tickets
model TicketTimeline {
  id        String   @id @default(uuid())
  ticketId  String
  eventType String   // created, status_changed, quote_submitted, quote_approved, etc.
  actorId   String?  // User who performed the action
  details   String?    // Event-specific details
  createdAt DateTime @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
  @@index([actorId])
}

// Webhook event logs for payment providers
model WebhookLog {
  id        String   @id @default(uuid())
  provider  String   // GOCARDLESS, STRIPE, TRUELAYER, YAPILY
  eventId   String   // Provider's event ID
  action    String   // Event action/type
  payload   String   // Full webhook payload as JSON
  processed Boolean  @default(false)
  error     String?  // Error message if processing failed
  createdAt DateTime @default(now())

  @@index([provider, eventId])
  @@index([processed])
  @@index([createdAt])
}
